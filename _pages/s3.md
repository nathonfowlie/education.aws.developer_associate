---
title: "S3"
header:
  image: "/assets/images/aws_developer_associate_teaser.jpg"
permalink: /s3/
sidebar:
  nav: "docs"
toc: true
toc_icon: "book-reader"
toc_label: "Table of Contents"
---

## Overview

- Each bucket sits in a region, even though S3 is a global service
- Buckets must have a globally unique name
- Consists of buckets and objects
- Public access is blocked by default
- Bucket names must following a DNS compliant naming convention -
  - No uppercase
  - No underscore
  - 3-63 chars
  - Not an IP
  - Must start with a lowercase letter or number

## S3 Objects

- Object key is the full path to the file. eg: my_file.txt, path/to/myfile.txt
- Prefix is the file path (path/to/file/)
- Object name is the file name (my_file.txt)
- Object value is the file contents
- Max object size is 5TB
- Use multi-part upload for anything over 5GB
- Additional metadata stored as key/value pairs
- Can be tagged
- Have a version id if versioning is enabled. Initially the id is *null* for existing objects
- Objects within the bucket can have different ACLs, encryption methods, storage classes etc
- Pre-signed URLs can be used to access an object without using the public URL.

### Versioning

- Enabled at the bucket level
- New version generated each time an object with the same key is over-written
- Files not versioned prior to enabling versioning will have the version "null"
- Suspending versioning doesn't delete the previous versions
- Delete marker is created when a file is deleted. Old versions of the file will remain accessible
- Deleting the delete marker, will result in the latest version of the file being restored

## Encryption

There's four ways to encrypt objects, and it's possible to define a default encryption method for a bucket -

| Method                 | Description                                                                  |
|------------------------|------------------------------------------------------------------------------|
| SS3-S3                 | Use keys handled and managed by AWS.                                         |
| SSE-KMS                | Use AWS KMS to manage encryption keys.                                       |
| SSE-C                  | Manage your own encryption keys.                                             |
| Client Side Encryption | Customer fully managed the encryption/decryption process on the client side. |

### SSE-S3

- Encryption keys managed by AWS S3
- Server-side encryption
- Uses AES-256
- Must add the header **"x-amz-server-side-encryption": "AES256"**

### SSE-KMS

- Uses AWS KMS to manage encryption keys
- Provides control over who has access to the keys, plus an audit trail
- Server-side encryption
- Uses the Customer Master Key (CMK) to encrypt the object
- Must add the header **"x-amz-server-side-encryption": "aws:kms"**

### SSE-C

- Uses Client side data key provided by the user (outside of AWS)
- Server-side encryption
- Key is not stored by S3
- Must use HTTPS
- Encryption key needs to be in the HTTP header

### Client Side Encryption

- Customer fully controls the encryption/decryption cycle
- Object encrypted prior to upload
- S3 Encryption Client library can help do this
- Clients must encrypt/decrypt the object themselves

### Encryption in Transit (TLS/SS)

- S3 endpoints can be utilized using HTTP, or HTTPS.

### Default Encryption

- Bucket polcies are evaluated before default encryption.
- Can set it to AES-256 using SSE-S3, or AWS-KMS, using SSE-KMS.

## S3 Security

### User Based Security

Security is defined by IAM policies that control which API calls are allowed for a given user.

The IAM principal (user) can access an S3 Object if:

  - The users IAM permissions allow it, or the resource policy allows it.
  - There's no explicit DENY on the bucket policy.

### Resource Based Security

There's two types of resource based security:

| Type                             | Description                                                                     |
|----------------------------------|---------------------------------------------------------------------------------|
| Object Access Control List (ACL) | Applies to the whole bucket, but allows ACLs to be defined at the object level. |
| Bucket Access Control List (ACL) | Applies to the whole bucket, less commonly used.                                |

#### Bucket Policy

- Applies to the whole bucket.
- Rules are defined in the S3 console, which allows cross-account access.
- JSON format.
- Can be applied to bucket and objects.
- General structure:

        {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Sid": "PublicRead",
                    "Effect": "Allow",
                    "Principal": "*",
                    "Action": [
                        "s3:GetObject"
                    ],
                    "Resource": [
                        "arn:aws:s3:::mybucket/*"
                    ]
                }
            ]
        }
- Blocking public access to buckets and objects can be done through:
  - *new* Access Control Lists (ACLs)
  - *any* Access Control Lists (ACLs)
  - *new* public bucket or access point policies
- Blocking public and cross-account access to buckets and objects can be done through:
  - *any* public bucket or access point policy.
- Blocking public access to buckets can be set at the account level.

### Networking

- A VPC endpoint allows access to private buckets within a VPC from other resources in that VPC.

### Logging & Auditing

- S3 access logs can be stored in another S3 bucket.
- API call audit events are stored in CloudTrail.

#### S3 Access Logs

- Log all access to S3 bucket, into another bucket.
- Can analyse the access logs using data analysis tools or Athena.
- Don't send logs to the same bucket that's being monitored (duh).
- Can define a prefix to use on all of the generated logfiles.

### User Security

- MFA can be required in versioned buckets to delete objects.
- Pre-signed URLs that are signed with AWS credentials and are only available for a limited amount of time.

#### MFA-Delete

- Versioning must be enabled on the bucket.
- Requires MFA to permanently delete an object version (adding a marker), or suspend versioning on the bucket.
- Not required to enable versioning.
- Can only be enabled/disabled by the bucket owner.
- Can only be configured via the CLI.

#### Pre-signed URLs

- Can be created via CLI or the SDK.
- Default expiration is 3600secs. Change using the ```--expires-in``` argument.
- Users given the pre-signed URL inherit the permissions of the person that generated the URL to allow HTTP GET/PUT.
- The S3 signature version needs to be s3v4.

##### Use Cases

- Allow only logged in users to download a resource.
- Need to generate URLs dynamically because there's high user churn.
- Temporarily allow a user to upload a file to a specific location in the bucket.

##### Generating a Pre-signed URL

    aws configure set default.s3.signature_version s3v4
    aws s3 presign <S3Uri> --expires-in <seconds> --region <bucket region>

## S3 Static Websites

- <bucket name>.s3-website-<region>.amazonaws.com
- Bucket needs to be public, and have a S3 policy that allows public reads, otherwise you'll get a 403 error.
- Bucket objects need to be un-encrypted.
- Can set a custom index and error page.
- Can define redirection rules.

### CORS

- Origin is a scheme, host and port (https:// on port 443 etc).
- Allows the website to make requests to other origins than have been white-listed.
- Uses the Access-Control-Allow-Origin header to control what origins are permitted to access web resources.

### S3 CORS

- Can allow for a specific origin via an explicit name, or use "*" to allow all origins.
- CORS headers must be enabled on the cross-origin bucket, to allow a client to do a cross-origin request.

## Consistency Model

- Read after write consistency for PUTS of new objects.
- Eventually consistent for DELETEs and PUTS of existing objects.
- There is no way to request strong consistency.

## S3 Replication

- Asynchronous replication.
- Must enable versioning in the source and destination buckets.
- Requires an IAM role with permissions to copy between buckets.
- Not retroactive. Only new objects created after replication is enabled will be copied across.
- Deletes are not replicated. Deleting without an version id will create a delete marker. Deleting with a version id will delete in the source only.
- No replication chaining. Where bucket1 is replicating into bucket2, and bucket2 is replicating into bucket3, objects created in bucket1 won't be replicated to bucket3.
- Can replicate the whole bucket, or only specific prefixes/tags.
- Can replicate objects encrypted with AWS KMS.

### CRR

- Cross Region Replication.
- Compliance, Low latency access, replication across accounts.

### SRR

- Same Region Replication.
- Log aggregation, live replication between prod and test accounts.

## S3 Storage Classes

### S3 Standard - General Purpose

- 11 9's durability.
- 4 9's availability.
- Can handle upto 2 concurrent facility failures.
- General purpose
- Minimum storage duration is 30 days.
- No retrieval fee.

#### Use Cases

- Big data analytics.
- Mobile & gaming applications.
- Content distribution.

### S3 Standard - Infrequent Access (IA)

- Data that isn't accessed very often, but needs to be retrieved quickly when needed.
- 11 9's durability.
- 3 9's availability.
- Cheaper than S3 Standard
- Minimum storage duration is 30 days.
- Retrieval fee per GB retrieved.

### Use Cases

- DR
- Backups

### S3  One Zone - Infrequent Access

- Same as IA, but data stored in a single AZ.
- 11 9's durability of objects in a single AZ.
- 99.5% availability.
- Low latency, high throughput.
- Supports SSL for encryption at in transit/at rest.
- 20% cheaper than IA.
- Minimum storage duration is 30 days.
- Retrieval fee per GB retrieved.

#### Use Cases

- Secondary backup copies of on-prem data.
- Storing data that could be re-created if needed.

### S3 Intelligent Tiering

- Low latency, high throughput.
- Additional cost to monitor objects and automatically move them between two different access tiers.
- 11 9's durability.
- 3 9's availability.
- Resilient to loss of entire AZ.
- Minimum storage duration is 30 days.
- No retrieval fee.

### Glacier

- Low cost intended for archiving/backups.
- Data retaining for a long time (multiple years).
- Alternative to magnetic tape storage.
- 11 9's durability.
- Each object is called an Archive and can be upto 40TB.
- Archives are stored in Vaults, not buckets.
- Minimum storage duration is 90 days.
- Retrieval fee per GB retrieved.

#### Retrieval Options

- Expidited (1-5mins).
- Standard (3-5hrs).
- Bulk (5-12hrs).

#### Use Cases

### Glacier Deep Archive

- Cheapest option.
- Minimum storage duration is 180 days.

#### Retrieval Options

- Standard (12hrs).
- Bulk (48hrs).


## Lifecycle Configuration (Policies)

- Lifecycle rules define transition actions. When to move an object to another storage class.
- Expiration actions define when an object, or previous versions will be deleted, or to clean up incomplete multi-part uploads.
- Rules can be applied against a specific prefix, or object tags.

### Lifecycle Rule Actions

- Transition current versions between storage classes.
- Transition previous versions between storage classes.
- Expire current versions.
- Permanently delete previous versions.
- Delete expired delete markers or incomplete multi-part uploads.

## Performance

- Latency of 100-200ms.
- 3,500 PUT/COPY/POST/DELETE requests per second per bucket prefix.
- 5,500 GET/HEAD requests per second per bucket prefix.
- Using SSE-KMS will impose KMS limits (fixed number of API requests per second, depending on the region. Can't be changed).

### Optimising

- Use multi-part uploads for files over 100MB. Mandatory for 5GB+.
- Use S3 Transfer Acceleration for uploads. Transfers the file to an edge location, and forwards it from there to the S3 bucket using the private AWS network.
- Use S3 Byte-Range fetches to download files (simlar to multi-part uploads).
- Only retrieve part of the object (ie: the head of a file).

## S3 Select/Glacier Select

- Retrieve less data using SQL via server side filtering.
- Can filter rows and columns.
- Reduces network transfer, client-side CPU usage.
- Useful for structured data (csv files etc).

## Event Notifications

- S3:ObjectCreated, S3:ObjectRemoved, S3:ObjectRestore, S3:Replication
- Can be filtered by object name.
- Good use case, is generating thumbnails when an image is uploaded to S3.
- Usually delivered in seconds.
- Bucket versioning is required to ensure an event is sent for every successful write.
- Can send the event to SQS, SNS or Lambda function.

## S3 Object Lock/Glacier Vault Lock

- Write Once, Read Many.
- Block object version deletion for a specified amount of time.

## Glacier Vault Lock

- Write Once, Read Many.
- Lock the policy for future edits.
- Useful for compliance & data retention.
